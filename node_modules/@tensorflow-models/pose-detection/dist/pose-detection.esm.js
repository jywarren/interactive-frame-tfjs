/**
    * @license
    * Copyright 2021 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
import{Pose as t}from"@mediapipe/pose";import{loadGraphModel as e}from"@tensorflow/tfjs-converter";import{Tensor as i,browser as n,util as r,tidy as o,tensor2d as s,image as a,expandDims as l,cast as h,add as u,mul as c,slice as p,sigmoid as f,squeeze as d,dispose as m,tensor1d as g,div as y,exp as v,sub as x,concat as w,reshape as b,clipByValue as M,zeros as S,getBackend as _,scalar as k,argMax as R}from"@tensorflow/tfjs-core";var F=function(){return(F=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function T(t,e,i,n){return new(i||(i=Promise))((function(r,o){function s(t){try{l(n.next(t))}catch(t){o(t)}}function a(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,a)}l((n=n.apply(t,e||[])).next())}))}function O(t,e){var i,n,r,o,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){s.label=o[1];break}if(6===o[0]&&s.label<r[1]){s.label=r[1],r=o;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(o);break}r[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var P=["nose","left_eye","right_eye","left_ear","right_ear","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle"],z=["nose","left_eye_inner","left_eye","left_eye_outer","right_eye_inner","right_eye","right_eye_outer","left_ear","right_ear","mouth_left","mouth_right","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_pinky","right_pinky","left_index","right_index","left_thumb","right_thumb","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle","left_heel","right_heel","left_foot_index","right_foot_index"],C={left:[1,2,3,7,9,11,13,15,17,19,21,23,25,27,29,31],right:[4,5,6,8,10,12,14,16,18,20,22,24,26,28,30,32],middle:[0]},I={left:[1,3,5,7,9,11,13,15],right:[2,4,6,8,10,12,14,16],middle:[0]},E=[[0,1],[0,2],[1,3],[2,4],[5,6],[5,7],[5,11],[6,8],[6,12],[7,9],[8,10],[11,12],[11,13],[12,14],[13,15],[14,16]],A=[[0,1],[0,4],[1,2],[2,3],[3,7],[4,5],[5,6],[6,8],[9,10],[11,12],[11,13],[11,23],[12,14],[14,16],[12,24],[13,15],[15,17],[16,18],[16,20],[15,17],[15,19],[15,21],[16,22],[17,19],[18,20],[23,25],[23,24],[24,26],[25,27],[26,28],[27,29],[28,30],[27,31],[28,32],[29,31],[30,32]],B={runtime:"mediapipe",enableSmoothing:!0,modelType:"full"};var N=function(){function e(e){var i,n=this;switch(this.width=0,this.height=0,this.selfieMode=!1,this.poseSolution=new t({locateFile:function(t,i){return e.solutionPath?e.solutionPath.replace(/\/+$/,"")+"/"+t:i+"/"+t}}),e.modelType){case"lite":i=0;break;case"heavy":i=2;break;case"full":default:i=1}this.poseSolution.setOptions({modelComplexity:i,smoothLandmarks:e.enableSmoothing||!0,selfieMode:this.selfieMode}),this.poseSolution.onResults((function(t){n.height=t.image.height,n.width=t.image.width,n.poses=n.translateOutputs(t)}))}return e.prototype.translateOutputs=function(t){var e=this;return null!=t.poseLandmarks?[{keypoints:t.poseLandmarks.map((function(t,i){return{x:t.x*e.width,y:t.y*e.height,z:t.z,score:t.visibility,name:z[i]}}))}]:[]},e.prototype.estimatePoses=function(t,e,i){return T(this,void 0,void 0,(function(){return O(this,(function(n){switch(n.label){case 0:return e&&e.flipHorizontal&&e.flipHorizontal!==this.selfieMode&&(this.selfieMode=e.flipHorizontal,this.poseSolution.setOptions({selfieMode:this.selfieMode})),[4,this.poseSolution.send({image:t},i)];case 1:return n.sent(),[2,this.poses]}}))}))},e.prototype.dispose=function(){this.poseSolution.close()},e.prototype.reset=function(){this.poseSolution.reset()},e.prototype.initialize=function(){return this.poseSolution.initialize()},e}();function V(t){return T(this,void 0,void 0,(function(){var e,i;return O(this,(function(n){switch(n.label){case 0:return e=function(t){if(null==t)return F({},B);var e=F({},t);return e.runtime="mediapipe",null==e.enableSmoothing&&(e.enableSmoothing=B.enableSmoothing),null==e.modelType&&(e.modelType=B.modelType),e}(t),[4,(i=new N(e)).initialize()];case 1:return n.sent(),[2,i]}}))}))}function K(t){return t instanceof i?{height:t.shape[0],width:t.shape[1]}:{height:t.height,width:t.width}}function L(t){return t-2*Math.PI*Math.floor((t+Math.PI)/(2*Math.PI))}function q(t){return t instanceof i?t:n.fromPixels(t)}function j(t,e){r.assert(0!==t.width,(function(){return e+" width cannot be 0."})),r.assert(0!==t.height,(function(){return e+" height cannot be 0."}))}function D(t,e,i){var n=e.inputResolution,r=e.keepAspectRatio,u=K(t),c=function(t,e){return e?{xCenter:e.xCenter*t.width,yCenter:e.yCenter*t.height,width:e.width*t.width,height:e.height*t.height,rotation:e.rotation}:{xCenter:.5*t.width,yCenter:.5*t.height,width:t.width,height:t.height,rotation:0}}(u,i),p=function(t,e,i){if(void 0===i&&(i=!1),!i)return{top:0,left:0,right:0,bottom:0};var n=e.height,r=e.width;j(e,"targetSize"),j(t,"roi");var o,s,a=n/r,l=t.height/t.width,h=0,u=0;return a>l?(o=t.width,s=t.width*a,u=(1-l/a)/2):(o=t.height/a,s=t.height,h=(1-a/l)/2),t.width=o,t.height=s,{top:u,left:h,right:h,bottom:u}}(c,n,r);return{imageTensor:o((function(){var e=q(t),i=s(function(t,e,i,n){j(n,"inputResolution");var r=1/e.width,o=1/e.height,s=t.xCenter,a=t.yCenter,l=Math.cos(t.rotation),h=Math.sin(t.rotation),u=i?-1:1,c=t.width,p=t.height;return[1/n.width*c*l*u*r*e.width,1/n.height*-p*h*r*e.width,(-.5*c*l*u+.5*p*h+s)*r*e.width,1/n.width*c*h*u*o*e.height,1/n.height*p*l*o*e.height,(-.5*p*l-.5*c*h*u+a)*o*e.height,0,0]}(c,u,!1,n),[1,8]);return a.transform(l(h(e,"float32")),i,"bilinear","nearest",0,[n.height,n.width])})),padding:p}}function X(t){return null!=t&&null!=t.currentTime}var H=function(){function t(t){this.alpha=t,this.initialized=!1}return t.prototype.apply=function(t,e){var i;return this.initialized?i=null==e?this.storedValue+this.alpha*(t-this.storedValue):this.storedValue+this.alpha*e*Math.asinh((t-this.storedValue)/e):(i=t,this.initialized=!0),this.rawValue=t,this.storedValue=i,i},t.prototype.applyWithAlpha=function(t,e,i){return this.alpha=e,this.apply(t,i)},t.prototype.hasLastRawValue=function(){return this.initialized},t.prototype.lastRawValue=function(){return this.rawValue},t.prototype.reset=function(){this.initialized=!1},t}(),Y=function(){function t(t){this.frequency=t.frequency,this.minCutOff=t.minCutOff,this.beta=t.beta,this.thresholdCutOff=t.thresholdCutOff,this.thresholdBeta=t.thresholdBeta,this.derivateCutOff=t.derivateCutOff,this.x=new H(this.getAlpha(this.minCutOff)),this.dx=new H(this.getAlpha(this.derivateCutOff)),this.lastTimestamp=0}return t.prototype.apply=function(t,e,i){if(null==t)return t;var n=Math.trunc(e);if(this.lastTimestamp>=n)return t;0!==this.lastTimestamp&&0!==n&&(this.frequency=1/(1e-6*(n-this.lastTimestamp))),this.lastTimestamp=n;var r=this.x.hasLastRawValue()?(t-this.x.lastRawValue())*i*this.frequency:0,o=this.dx.applyWithAlpha(r,this.getAlpha(this.derivateCutOff)),s=this.minCutOff+this.beta*Math.abs(o),a=null!=this.thresholdCutOff?this.thresholdCutOff+this.thresholdBeta*Math.abs(o):null;return this.x.applyWithAlpha(t,this.getAlpha(s),a)},t.prototype.getAlpha=function(t){return 1/(1+this.frequency/(2*Math.PI*t))},t}(),U=function(){function t(t){this.config=t}return t.prototype.apply=function(t,e,i){var n=this;if(null==t)return this.reset(),null;this.initializeFiltersIfEmpty(t);var r=1;if(null!=this.config.minAllowedObjectScale){if(i<this.config.minAllowedObjectScale)return t.slice();r=1/i}return t.map((function(t,i){var o=F({},t,{x:n.xFilters[i].apply(t.x,e,r),y:n.yFilters[i].apply(t.y,e,r)});return null!=t.z&&(o.z=n.zFilters[i].apply(t.z,e,r)),o}))},t.prototype.reset=function(){this.xFilters=null,this.yFilters=null,this.zFilters=null},t.prototype.initializeFiltersIfEmpty=function(t){var e=this;null!=this.xFilters&&this.xFilters.length===t.length||(this.xFilters=t.map((function(t){return new Y(e.config)})),this.yFilters=t.map((function(t){return new Y(e.config)})),this.zFilters=t.map((function(t){return new Y(e.config)})))},t}();function W(t,e){return t.map((function(t){var i=F({},t,{x:t.x/e.width,y:t.y/e.height});return null!=t.z&&(t.z=t.z/e.width),i}))}var Q=function(){function t(t){this.config=t,this.window=[],this.lowPassFilter=new H(1),this.lastValue=0,this.lastValueScale=1,this.lastTimestamp=-1}return t.prototype.apply=function(t,e,i){if(null==t)return t;var n,r=Math.trunc(e);if(this.lastTimestamp>=r)return t;if(-1===this.lastTimestamp)n=1;else{for(var o=t*i-this.lastValue*this.lastValueScale,s=r-this.lastTimestamp,a=o,l=s,h=(1+this.window.length)*(1e6/30),u=0,c=this.window;u<c.length;u++){var p=c[u];if(l+p.duration>h)break;a+=p.distance,l+=p.duration}var f=a/(1e-6*l);n=1-1/(1+this.config.velocityScale*Math.abs(f)),this.window.unshift({distance:o,duration:s}),this.window.length>this.config.windowSize&&this.window.pop()}return this.lastValue=t,this.lastValueScale=i,this.lastTimestamp=r,this.lowPassFilter.applyWithAlpha(t,n)},t}(),G=function(){function t(t){this.config=t}return t.prototype.apply=function(t,e,i){var n=this;if(null==t)return this.reset(),null;var r=1;if(!this.config.disableValueScaling){if(i<this.config.minAllowedObjectScale)return t.slice();r=1/i}return this.initializeFiltersIfEmpty(t),t.map((function(t,i){var o=F({},t,{x:n.xFilters[i].apply(t.x,e,r),y:n.yFilters[i].apply(t.y,e,r)});return null!=t.z&&(o.z=n.zFilters[i].apply(t.z,e,r)),o}))},t.prototype.reset=function(){this.xFilters=null,this.yFilters=null,this.zFilters=null},t.prototype.initializeFiltersIfEmpty=function(t){var e=this;null!=this.xFilters&&this.xFilters.length===t.length||(this.xFilters=t.map((function(t){return new Q(e.config)})),this.yFilters=t.map((function(t){return new Q(e.config)})),this.zFilters=t.map((function(t){return new Q(e.config)})))},t}();function Z(t,e){return t.map((function(t){var i=F({},t,{x:t.x*e.width,y:t.y*e.height});return null!=t.z&&(i.z=t.z*e.width),i}))}var $=function(){function t(t){if(null!=t.velocityFilter)this.keypointsFilter=new G(t.velocityFilter);else{if(null==t.oneEuroFilter)throw new Error("Either configure velocityFilter or oneEuroFilter, but got "+t+".");this.keypointsFilter=new U(t.oneEuroFilter)}}return t.prototype.apply=function(t,e,i,n,r){if(void 0===n&&(n=!1),null==t)return this.keypointsFilter.reset(),null;var o=null!=r?function(t,e){return(t.width*e.width+t.height*e.height)/2}(r,i):1,s=n?Z(t,i):t,a=this.keypointsFilter.apply(s,e,o);return n?W(a,i):a},t}();function J(t,e){var i=function(t,e,i,n){var r=e-t,o=n-i;if(0===r)throw new Error("Original min and max are both "+t+", range cannot be 0.");var s=o/r;return{scale:s,offset:i-t*s}}(0,255,e[0],e[1]);return o((function(){return u(c(t,i.scale),i.offset)}))}function tt(t,e,i){var n=i.rotationVectorStartKeypointIndex,r=i.rotationVectorEndKeypointIndex,o=t.locationData,s=o.relativeKeypoints[n].x*e.width,a=o.relativeKeypoints[n].y*e.height,l=o.relativeKeypoints[r].x*e.width,h=o.relativeKeypoints[r].y*e.height,u=2*Math.sqrt((l-s)*(l-s)+(h-a)*(h-a)),c=function(t,e,i){var n,r=t.locationData,o=i.rotationVectorStartKeypointIndex,s=i.rotationVectorEndKeypointIndex;n=i.rotationVectorTargetAngle?i.rotationVectorTargetAngle:Math.PI*i.rotationVectorTargetAngleDegree/180;var a=r.relativeKeypoints[o].x*e.width,l=r.relativeKeypoints[o].y*e.height,h=r.relativeKeypoints[s].x*e.width,u=r.relativeKeypoints[s].y*e.height;return L(n-Math.atan2(-(u-l),h-a))}(t,e,i);return{xCenter:s/e.width,yCenter:a/e.height,width:u/e.width,height:u/e.height,rotation:c}}function et(t,e,i,n){return 1===n?.5*(t+e):t+(e-t)*i/(n-1)}function it(t,e){return o((function(){var i=function(t){return o((function(){var e=p(t,[0,0,0],[1,-1,1]);return[f(e),p(t,[0,0,1],[1,-1,-1])]}))}(e.predict(t)),n=i[0],r=i[1];return{boxes:d(r),scores:d(n)}}))}function nt(t){for(var e={locationData:{relativeKeypoints:[]}},i=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,s=0;s<t.length;++s){var a=t[s];i=Math.min(i,a.x),n=Math.max(n,a.x),r=Math.min(r,a.y),o=Math.max(o,a.y),e.locationData.relativeKeypoints.push({x:a.x,y:a.y})}return e.locationData.relativeBoundingBox={xMin:i,yMin:r,xMax:n,yMax:o,width:n-i,height:o-r},e}function rt(t,e,i,n){return T(this,void 0,void 0,(function(){var r,o,l,h,u;return O(this,(function(c){switch(c.label){case 0:return r=s(t.map((function(t){return[t.locationData.relativeBoundingBox.yMin,t.locationData.relativeBoundingBox.xMin,t.locationData.relativeBoundingBox.yMax,t.locationData.relativeBoundingBox.xMax]}))),o=g(t.map((function(t){return t.score[0]}))),[4,a.nonMaxSuppressionAsync(r,o,e,i,n)];case 1:return[4,(l=c.sent()).array()];case 2:return h=c.sent(),u=t.filter((function(t,e){return h.indexOf(e)>-1})),m([r,o,l]),[2,u]}}))}))}function ot(t,e,i){return T(this,void 0,void 0,(function(){var n,r,o,s,a,l,h,u,c,p,f,m,g,y,v,x,w,b,M,S,_,k,R,T;return O(this,(function(O){switch(O.label){case 0:if(n=d(e,[0]),r=n.shape,o=r[0],s=r[1],a=r[2],t.length!==a)throw new Error("Expected heatmap to have same number of channels as the number of landmarks. But got landmarks length: "+t.length+", heatmap length: "+a);return l=[],[4,n.buffer()];case 1:for(h=O.sent(),u=0;u<t.length;u++)if(c=t[u],p=F({},c),l.push(p),f=Math.trunc(p.x*s),m=Math.trunc(p.y*o),!(f<0||f>=s||m<0||f>=o)){for(g=Math.trunc((i.kernelSize-1)/2),y=Math.max(0,f-g),v=Math.min(s,f+g+1),x=Math.max(0,m-g),w=Math.min(o,m+g+1),b=0,M=0,S=0,_=0,k=x;k<w;++k)for(R=y;R<v;++R)T=h.get(k,R,u),b+=T,_=Math.max(_,T),M+=R*T,S+=k*T;_>=i.minConfidenceToRefine&&b>0&&(p.x=M/s/b,p.y=S/o/b)}return n.dispose(),[2,l]}}))}))}function st(t,e,i){return T(this,void 0,void 0,(function(){var n,r,s,a,l;return O(this,(function(h){switch(h.label){case 0:return n=t[0],r=t[1],s=function(t,e,i){return o((function(){var n,r,o,s;i.reverseOutputOrder?(r=d(p(t,[0,i.boxCoordOffset+0],[-1,1])),n=d(p(t,[0,i.boxCoordOffset+1],[-1,1])),s=d(p(t,[0,i.boxCoordOffset+2],[-1,1])),o=d(p(t,[0,i.boxCoordOffset+3],[-1,1]))):(n=d(p(t,[0,i.boxCoordOffset+0],[-1,1])),r=d(p(t,[0,i.boxCoordOffset+1],[-1,1])),o=d(p(t,[0,i.boxCoordOffset+2],[-1,1])),s=d(p(t,[0,i.boxCoordOffset+3],[-1,1]))),r=u(c(y(r,i.xScale),e.w),e.x),n=u(c(y(n,i.yScale),e.h),e.y),i.applyExponentialOnBoxSize?(o=c(v(y(o,i.hScale)),e.h),s=c(v(y(s,i.wScale)),e.w)):(o=c(y(o,i.hScale),e.h),s=c(y(s,i.wScale),e.h));var a=x(n,y(o,2)),l=x(r,y(s,2)),h=u(n,y(o,2)),f=u(r,y(s,2)),m=w([b(a,[i.numBoxes,1]),b(l,[i.numBoxes,1]),b(h,[i.numBoxes,1]),b(f,[i.numBoxes,1])],1);if(i.numKeypoints)for(var g=0;g<i.numKeypoints;++g){var M=i.keypointCoordOffset+g*i.numValuesPerKeypoint,S=void 0,_=void 0;i.reverseOutputOrder?(S=d(p(t,[0,M],[-1,1])),_=d(p(t,[0,M+1],[-1,1]))):(_=d(p(t,[0,M],[-1,1])),S=d(p(t,[0,M+1],[-1,1])));var k=u(c(y(S,i.xScale),e.w),e.x),R=u(c(y(_,i.yScale),e.h),e.y);m=w([m,b(k,[i.numBoxes,1]),b(R,[i.numBoxes,1])],1)}return m}))}(r,e,i),a=o((function(){var t=n;return i.sigmoidScore?(null!=i.scoreClippingThresh&&(t=M(n,-i.scoreClippingThresh,i.scoreClippingThresh)),t=f(t)):t})),[4,at(s,a,i)];case 1:return l=h.sent(),m([s,a]),[2,l]}}))}))}function at(t,e,i){return T(this,void 0,void 0,(function(){var n,r,o,s,a,l,h,u,c,p,f,d;return O(this,(function(m){switch(m.label){case 0:return n=[],[4,t.data()];case 1:return r=m.sent(),[4,e.data()];case 2:for(o=m.sent(),s=0;s<i.numBoxes;++s)if(!(null!=i.minScoreThresh&&o[s]<i.minScoreThresh||(a=s*i.numCoords,l=lt(r[a+0],r[a+1],r[a+2],r[a+3],o[s],i.flipVertically,s),(h=l.locationData.relativeBoundingBox).width<0||h.height<0))){if(i.numKeypoints>0)for((u=l.locationData).relativeKeypoints=[],c=i.numKeypoints*i.numValuesPerKeypoint,p=0;p<c;p+=i.numValuesPerKeypoint)f=a+i.keypointCoordOffset+p,d={x:r[f+0],y:i.flipVertically?1-r[f+1]:r[f+1]},u.relativeKeypoints.push(d);n.push(l)}return[2,n]}}))}))}function lt(t,e,i,n,r,o,s){return{score:[r],ind:s,locationData:{relativeBoundingBox:{xMin:e,yMin:o?1-i:t,xMax:n,yMax:o?1-t:i,width:n-e,height:i-t}}}}function ht(t,e,i,n){return void 0===i&&(i=!1),void 0===n&&(n=!1),T(this,void 0,void 0,(function(){var r,o,s,a,l,h,u,c;return O(this,(function(p){switch(p.label){case 0:return r=t.size,o=r/e.numLandmarks,[4,t.data()];case 1:for(s=p.sent(),a=[],l=0;l<e.numLandmarks;++l)h=l*o,(c={x:0,y:0}).x=i?e.inputImageWidth-s[h]:s[h],o>1&&(c.y=n?e.inputImageHeight-s[h+1]:s[h+1]),o>2&&(c.z=s[h+2]),o>3&&(c.score=(f=s[h+3],1/(1+Math.exp(-f)))),a.push(c);for(u=0;u<a.length;++u)(c=a[u]).x=c.x/e.inputImageWidth,c.y=c.y/e.inputImageHeight,c.z=c.z/e.inputImageWidth/(e.normalizeZ||1);return[2,a]}var f}))}))}function ut(t,e,i){var n=t.width,r=t.height,o=t.rotation;if(null==i.rotation&&null==i.rotationDegree||(o=function(t,e){null!=e.rotation?t+=e.rotation:null!=e.rotationDegree&&(t+=Math.PI*e.rotationDegree/180);return L(t)}(o,i)),0===o)t.xCenter=t.xCenter+n*i.shiftX,t.yCenter=t.yCenter+r*i.shiftY;else{var s=(e.width*n*i.shiftX*Math.cos(o)-e.height*r*i.shiftY*Math.sin(o))/e.width,a=(e.width*n*i.shiftX*Math.sin(o)+e.height*r*i.shiftY*Math.cos(o))/e.height;t.xCenter=t.xCenter+s,t.yCenter=t.yCenter+a}if(i.squareLong){var l=Math.max(n*e.width,r*e.height);n=l/e.width,r=l/e.height}else if(i.squareShort){var h=Math.min(n*e.width,r*e.height);n=h/e.width,r=h/e.height}return t.width=n*i.scaleX,t.height=r*i.scaleY,t}var ct=function(){function t(t){this.alpha=t.alpha}return t.prototype.apply=function(t){var e=this;if(null==t)return this.visibilityFilters=null,null;null!=this.visibilityFilters&&this.visibilityFilters.length===t.length||(this.visibilityFilters=t.map((function(t){return new H(e.alpha)})));for(var i=[],n=0;n<t.length;++n){var r=t[n],o=F({},r);o.score=this.visibilityFilters[n].apply(r.score),i.push(o)}return i},t}(),pt={reduceBoxesInLowestlayer:!1,interpolatedScaleAspectRatio:1,featureMapHeight:[],featureMapWidth:[],numLayers:5,minScale:.1484375,maxScale:.75,inputSizeHeight:224,inputSizeWidth:224,anchorOffsetX:.5,anchorOffsetY:.5,strides:[8,16,32,32,32],aspectRatios:[1],fixedAnchorSize:!0},ft={runtime:"tfjs",modelType:"full",enableSmoothing:!0,detectorModelUrl:"https://tfhub.dev/mediapipe/tfjs-model/blazeposedetector/1/default/1",landmarkModelUrl:"https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_full/1/default/1"},dt={maxPoses:1,flipHorizontal:!1},mt={applyExponentialOnBoxSize:!1,flipVertically:!1,ignoreClasses:[],numClasses:1,numBoxes:2254,numCoords:12,boxCoordOffset:0,keypointCoordOffset:4,numKeypoints:4,numValuesPerKeypoint:2,sigmoidScore:!0,scoreClippingThresh:100,reverseOutputOrder:!0,xScale:224,yScale:224,hScale:224,wScale:224,minScoreThresh:.5},gt=-1,yt=.3,vt={shiftX:0,shiftY:0,scaleX:1.25,scaleY:1.25,squareLong:!0},xt={inputResolution:{width:224,height:224},keepAspectRatio:!0},wt={inputResolution:{width:256,height:256},keepAspectRatio:!0},bt={numLandmarks:39,inputImageWidth:256,inputImageHeight:256},Mt={kernelSize:7,minConfidenceToRefine:.5},St={alpha:.1},_t={oneEuroFilter:{frequency:30,minCutOff:.05,beta:80,derivateCutOff:1,minAllowedObjectScale:1e-6}},kt={oneEuroFilter:{frequency:30,minCutOff:.01,beta:10,derivateCutOff:1,minAllowedObjectScale:1e-6}};var Rt,Ft=function(){function t(t,e,i,n){this.detectorModel=t,this.landmarkModel=e,this.enableSmoothing=i,this.modelType=n,this.regionOfInterest=null,this.anchors=function(t){for(var e=[],i=0;i<t.numLayers;){for(var n=[],r=[],o=[],s=[],a=i;a<t.strides.length&&t.strides[a]===t.strides[i];){var l=et(t.minScale,t.maxScale,a,t.strides.length);if(0===a&&t.reduceBoxesInLowestLayer)o.push(1),o.push(2),o.push(.5),s.push(.1),s.push(l),s.push(l);else{for(var h=0;h<t.aspectRatios.length;++h)o.push(t.aspectRatios[h]),s.push(l);if(t.interpolatedScaleAspectRatio>0){var u=a===t.strides.length-1?1:et(t.minScale,t.maxScale,a+1,t.strides.length);s.push(Math.sqrt(l*u)),o.push(t.interpolatedScaleAspectRatio)}}a++}for(var c=0;c<o.length;++c){var p=Math.sqrt(o[c]);n.push(s[c]/p),r.push(s[c]*p)}var f=0,d=0;if(t.featureMapHeight.length>0)f=t.featureMapHeight[i],d=t.featureMapWidth[i];else{var m=t.strides[i];f=Math.ceil(t.inputSizeHeight/m),d=Math.ceil(t.inputSizeWidth/m)}for(var g=0;g<f;++g)for(var y=0;y<d;++y)for(var v=0;v<n.length;++v){var x={xCenter:(y+t.anchorOffsetX)/d,yCenter:(g+t.anchorOffsetY)/f,width:0,height:0};t.fixedAnchorSize?(x.width=1,x.height=1):(x.width=r[v],x.height=n[v]),e.push(x)}i=a}return e}(pt);var r=g(this.anchors.map((function(t){return t.width}))),o=g(this.anchors.map((function(t){return t.height}))),s=g(this.anchors.map((function(t){return t.xCenter}))),a=g(this.anchors.map((function(t){return t.yCenter})));this.anchorTensor={x:s,y:a,w:r,h:o}}return t.prototype.estimatePoses=function(t,e,i){return T(this,void 0,void 0,(function(){var n,r,s,a,l,u,c,p,f,d,m,g,y,v,x;return O(this,(function(w){switch(w.label){case 0:return n=function(t){var e;if(null==(e=null==t?dt:F({},t)).maxPoses&&(e.maxPoses=1),e.maxPoses<=0)throw new Error("Invalid maxPoses "+e.maxPoses+". Should be > 0.");if(e.maxPoses>1)throw new Error("Multi-pose detection is not implemented yet. Please set maxPoses to 1.");return e}(e),null==t?(this.reset(),[2,[]]):(this.maxPoses=n.maxPoses,this.timestamp=null!=i?1e3*i:X(t)?1e6*t.currentTime:null,r=K(t),s=o((function(){return h(q(t),"float32")})),null!=(a=this.regionOfInterest)?[3,2]:[4,this.detectPose(s)]);case 1:if(0===(l=w.sent()).length)return this.reset(),s.dispose(),[2,[]];u=l[0],a=this.poseDetectionToRoi(u,r),w.label=2;case 2:return[4,this.poseLandmarksByRoi(a,s)];case 3:return c=w.sent(),s.dispose(),null==c?(this.reset(),[2,[]]):(p=c.actualLandmarks,f=c.auxiliaryLandmarks,d=c.poseScore,m=this.poseLandmarkFiltering(p,f,r),g=m.actualLandmarksFiltered,y=m.auxiliaryLandmarksFiltered,v=this.poseLandmarksToRoi(y,r),this.regionOfInterest=v,null!=(x=null!=g?Z(g,r):null)&&x.forEach((function(t,e){t.name=z[e]})),[2,[{score:d,keypoints:x}]])}}))}))},t.prototype.dispose=function(){this.detectorModel.dispose(),this.landmarkModel.dispose(),m([this.anchorTensor.x,this.anchorTensor.y,this.anchorTensor.w,this.anchorTensor.h])},t.prototype.reset=function(){this.regionOfInterest=null,this.visibilitySmoothingFilterActual=null,this.visibilitySmoothingFilterAuxiliary=null,this.landmarksSmoothingFilterActual=null,this.landmarksSmoothingFilterAuxiliary=null},t.prototype.detectPose=function(t){return T(this,void 0,void 0,(function(){var e,i,n,r,o,s,a,l,h;return O(this,(function(u){switch(u.label){case 0:return e=D(t,xt),i=e.imageTensor,n=e.padding,r=J(i,[-1,1]),o=it(r,this.detectorModel),s=o.boxes,[4,st([a=o.scores,s],this.anchorTensor,mt)];case 1:return[4,rt(u.sent(),this.maxPoses,yt,gt)];case 2:return l=u.sent(),h=function(t,e){void 0===t&&(t=[]);for(var i=e.left,n=e.top,r=e.left+e.right,o=e.top+e.bottom,s=0;s<t.length;s++){var a=t[s],l=a.locationData.relativeBoundingBox,h=(l.xMin-i)/(1-r),u=(l.yMin-n)/(1-o),c=l.width/(1-r),p=l.height/(1-o);l.xMin=h,l.yMin=u,l.width=c,l.height=p;for(var f=0;f<a.locationData.relativeKeypoints.length;++f){var d=a.locationData.relativeKeypoints[f],m=(d.x-i)/(1-r),g=(d.y-n)/(1-o);d.x=m,d.y=g}}return t}(l,n),m([i,r,a,s]),[2,h]}}))}))},t.prototype.poseDetectionToRoi=function(t,e){return 0,1,ut(tt(t,e,{rotationVectorEndKeypointIndex:1,rotationVectorStartKeypointIndex:0,rotationVectorTargetAngleDegree:90}),e,vt)},t.prototype.poseLandmarksByRoi=function(t,e){return T(this,void 0,void 0,(function(){var i,n,r,o,s,a,l,h,u,c,p,f,d,g;return O(this,(function(y){switch(y.label){case 0:switch(i=D(e,wt,t),n=i.imageTensor,r=i.padding,o=J(n,[0,1]),s=this.landmarkModel.predict(o),this.modelType){case"lite":a=s[2],l=s[4],h=s[3];break;case"full":a=s[4],l=s[3],h=s[1];break;case"heavy":a=s[3],l=s[1],h=s[4];break;default:throw new Error("Model type must be one of lite, full or heavy,but got "+this.modelType)}return[4,l.data()];case 1:return(u=y.sent()[0])<.5?(m(s),m([n,o]),[2,null]):[4,ht(a,bt)];case 2:return[4,ot(y.sent(),h,Mt)];case 3:return c=y.sent(),p=function(t,e){var i=e.left,n=e.top,r=e.left+e.right,o=e.top+e.bottom;return t.map((function(t){return F({},t,{x:(t.x-i)/(1-r),y:(t.y-n)/(1-o),z:t.z/(1-r)})}))}(c,r),f=function(t,e,i){void 0===i&&(i={ignoreRotation:!1});for(var n=[],r=0,o=t;r<o.length;r++){var s=o[r],a=s.x-.5,l=s.y-.5,h=i.ignoreRotation?0:e.rotation,u=Math.cos(h)*a-Math.sin(h)*l,c=Math.sin(h)*a+Math.cos(h)*l;u=u*e.width+e.xCenter,c=c*e.height+e.yCenter;var p=s.z*e.width,f=F({},s);f.x=u,f.y=c,f.z=p,n.push(f)}return n}(p,t),d=f.slice(0,33),g=f.slice(33,35),m(s),m([n,o]),[2,{actualLandmarks:d,auxiliaryLandmarks:g,poseScore:u}]}}))}))},t.prototype.poseLandmarksToRoi=function(t,e){return ut(tt(nt(t),e,{rotationVectorStartKeypointIndex:0,rotationVectorEndKeypointIndex:1,rotationVectorTargetAngleDegree:90}),e,vt)},t.prototype.poseLandmarkFiltering=function(t,e,i){var n,r;if(null!=this.timestamp&&this.enableSmoothing){var o=tt(nt(e),i,{rotationVectorEndKeypointIndex:0,rotationVectorStartKeypointIndex:1,rotationVectorTargetAngleDegree:90});null==this.visibilitySmoothingFilterActual&&(this.visibilitySmoothingFilterActual=new ct(St)),n=this.visibilitySmoothingFilterActual.apply(t),null==this.visibilitySmoothingFilterAuxiliary&&(this.visibilitySmoothingFilterAuxiliary=new ct(St)),r=this.visibilitySmoothingFilterAuxiliary.apply(e),null==this.landmarksSmoothingFilterActual&&(this.landmarksSmoothingFilterActual=new $(_t)),n=this.landmarksSmoothingFilterActual.apply(n,this.timestamp,i,!0,o),null==this.landmarksSmoothingFilterAuxiliary&&(this.landmarksSmoothingFilterAuxiliary=new $(kt)),r=this.landmarksSmoothingFilterAuxiliary.apply(r,this.timestamp,i,!0,o)}else n=t,r=e;return{actualLandmarksFiltered:n,auxiliaryLandmarksFiltered:r}},t}();function Tt(t){return T(this,void 0,void 0,(function(){var i,n,r,o,s,a;return O(this,(function(l){switch(l.label){case 0:return i=function(t){var e=F({},null==t?ft:t);if(null==e.enableSmoothing&&(e.enableSmoothing=ft.enableSmoothing),null==e.modelType&&(e.modelType=ft.modelType),null==e.detectorModelUrl&&(e.detectorModelUrl=ft.detectorModelUrl),null==e.landmarkModelUrl)switch(e.modelType){case"lite":e.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_lite/1/default/1";break;case"heavy":e.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_heavy/1/default/1";break;case"full":default:e.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazeposelandmark_full/1/default/1"}return e}(t),n=i.detectorModelUrl.indexOf("https://tfhub.dev")>-1,r=i.landmarkModelUrl.indexOf("https://tfhub.dev")>-1,[4,Promise.all([e(i.detectorModelUrl,{fromTFHub:n}),e(i.landmarkModelUrl,{fromTFHub:r})])];case 1:return o=l.sent(),s=o[0],a=o[1],[2,new Ft(s,a,i.enableSmoothing,i.modelType)]}}))}))}function Ot(t){switch(t){case Rt.BlazePose:return z.reduce((function(t,e,i){return t[e]=i,t}),{});case Rt.PoseNet:case Rt.MoveNet:return P.reduce((function(t,e,i){return t[e]=i,t}),{});default:throw new Error("Model "+t+" is not supported.")}}!function(t){t.MoveNet="MoveNet",t.BlazePose="BlazePose",t.PoseNet="PoseNet"}(Rt||(Rt={}));var Pt=Object.freeze({__proto__:null,getKeypointIndexBySide:function(t){switch(t){case Rt.BlazePose:return C;case Rt.PoseNet:case Rt.MoveNet:return I;default:throw new Error("Model "+t+" is not supported.")}},getAdjacentPairs:function(t){switch(t){case Rt.BlazePose:return A;case Rt.PoseNet:case Rt.MoveNet:return E;default:throw new Error("Model "+t+" is not supported.")}},getKeypointIndexByName:Ot}),zt=["SinglePose.Lightning","SinglePose.Thunder"],Ct={modelType:"SinglePose.Lightning",enableSmoothing:!0},It={maxPoses:1},Et={frequency:30,minCutOff:6.36,beta:636.61,derivateCutOff:4.77,thresholdCutOff:.5,thresholdBeta:5};var At=function(){function t(t,e){this.moveNetModel=t,this.modelInputResolution={height:0,width:0},this.keypointIndexByName=Ot(Rt.MoveNet),this.keypointsFilter=new U(Et),this.cropRegionFilterYMin=new H(.9),this.cropRegionFilterXMin=new H(.9),this.cropRegionFilterYMax=new H(.9),this.cropRegionFilterXMax=new H(.9),"SinglePose.Lightning"===e.modelType?(this.modelInputResolution.width=192,this.modelInputResolution.height=192):"SinglePose.Thunder"===e.modelType&&(this.modelInputResolution.width=256,this.modelInputResolution.height=256),this.enableSmoothing=e.enableSmoothing}return t.prototype.detectKeypoints=function(t,e){return void 0===e&&(e=!0),T(this,void 0,void 0,(function(){var i,n,r,o,s;return O(this,(function(a){switch(a.label){case 0:return this.moveNetModel?(i=17,e?(n=this.moveNetModel.execute(t),[3,3]):[3,1]):[2,null];case 1:return[4,this.moveNetModel.executeAsync(t)];case 2:n=a.sent(),a.label=3;case 3:return n&&4===n.shape.length&&1===n.shape[0]&&1===n.shape[1]&&n.shape[2]===i&&3===n.shape[3]?"webgpu"===_()?[3,4]:(r=n.dataSync(),[3,6]):(n.dispose(),[2,null]);case 4:return[4,n.data()];case 5:r=a.sent(),a.label=6;case 6:for(n.dispose(),o=[],s=0;s<i;++s)o[s]={y:r[3*s],x:r[3*s+1],score:r[3*s+2]};return[2,o]}}))}))},t.prototype.estimatePoses=function(t,e,n){return void 0===e&&(e=It),T(this,void 0,void 0,(function(){var r,u,c,p,f,d,m,g,y,v=this;return O(this,(function(x){switch(x.label){case 0:return e=function(t){var e=null==t?It:F({},t);if(e.maxPoses||(e.maxPoses=1),e.maxPoses<=0||e.maxPoses>1)throw new Error("Invalid maxPoses "+e.maxPoses+". Should be 1.");return e}(e),null==t?(this.reset(),[2,[]]):(null==n?X(t)&&(n=1e6*t.currentTime):n*=1e3,r=q(t),u=K(r),c=l(r,0),t instanceof i||r.dispose(),this.cropRegion||(this.cropRegion=this.initCropRegion(u.width,u.height)),p=o((function(){var t=s([[v.cropRegion.yMin,v.cropRegion.xMin,v.cropRegion.yMax,v.cropRegion.xMax]]),e=S([1],"int32"),i=[v.modelInputResolution.height,v.modelInputResolution.width];return h(a.cropAndResize(c,t,e,i,"bilinear",0),"int32")})),c.dispose(),[4,this.detectKeypoints(p)]);case 1:if(f=x.sent(),p.dispose(),null==f)return this.reset(),[2,[]];for(y=0;y<f.length;++y)f[y].y=this.cropRegion.yMin+f[y].y*this.cropRegion.height,f[y].x=this.cropRegion.xMin+f[y].x*this.cropRegion.width;for(null!=n&&this.enableSmoothing&&(f=this.keypointsFilter.apply(f,n,1)),d=this.determineCropRegion(f,u.height,u.width),this.cropRegion=this.filterCropRegion(d),m=0,g=0,y=0;y<f.length;++y)f[y].name=P[y],f[y].y*=u.height,f[y].x*=u.width,f[y].score>.2&&(++m,g+=f[y].score);return m>0?g/=m:this.resetFilters(),[2,[{score:g,keypoints:f}]]}}))}))},t.prototype.filterCropRegion=function(t){if(t){var e=this.cropRegionFilterYMin.apply(t.yMin),i=this.cropRegionFilterXMin.apply(t.xMin),n=this.cropRegionFilterYMax.apply(t.yMax),r=this.cropRegionFilterXMax.apply(t.xMax);return{yMin:e,xMin:i,yMax:n,xMax:r,height:n-e,width:r-i}}return this.cropRegionFilterYMin.reset(),this.cropRegionFilterXMin.reset(),this.cropRegionFilterYMax.reset(),this.cropRegionFilterXMax.reset(),null},t.prototype.dispose=function(){this.moveNetModel.dispose()},t.prototype.reset=function(){this.cropRegion=null,this.resetFilters()},t.prototype.resetFilters=function(){this.keypointsFilter.reset(),this.cropRegionFilterYMin.reset(),this.cropRegionFilterXMin.reset(),this.cropRegionFilterYMax.reset(),this.cropRegionFilterXMax.reset()},t.prototype.torsoVisible=function(t){return(t[this.keypointIndexByName.left_hip].score>.2||t[this.keypointIndexByName.right_hip].score>.2)&&(t[this.keypointIndexByName.left_shoulder].score>.2||t[this.keypointIndexByName.right_shoulder].score>.2)},t.prototype.determineTorsoAndBodyRange=function(t,e,i,n){for(var r=["left_shoulder","right_shoulder","left_hip","right_hip"],o=0,s=0,a=0;a<r.length;a++){(p=Math.abs(i-e[r[a]][0]))>o&&(o=p),(f=Math.abs(n-e[r[a]][1]))>s&&(s=f)}for(var l=0,h=0,u=0,c=Object.keys(e);u<c.length;u++){var p,f,d=c[u];if(!(t[this.keypointIndexByName[d]].score<.2))(p=Math.abs(i-e[d][0]))>l&&(l=p),(f=Math.abs(n-e[d][1]))>h&&(h=f)}return[o,s,l,h]},t.prototype.determineCropRegion=function(t,e,i){for(var n={},r=0,o=P;r<o.length;r++){var s=o[r];n[s]=[t[this.keypointIndexByName[s]].y*e,t[this.keypointIndexByName[s]].x*i]}if(this.torsoVisible(t)){var a=(n.left_hip[0]+n.right_hip[0])/2,l=(n.left_hip[1]+n.right_hip[1])/2,h=this.determineTorsoAndBodyRange(t,n,a,l),u=h[0],c=h[1],p=h[2],f=h[3],d=Math.max(1.9*c,1.9*u,1.2*p,1.2*f),m=[a-(d=Math.min(d,Math.max(l,i-l,a,e-a))),l-d];if(d>Math.max(i,e)/2)return this.initCropRegion(e,i);var g=2*d;return{yMin:m[0]/e,xMin:m[1]/i,yMax:(m[0]+g)/e,xMax:(m[1]+g)/i,height:(m[0]+g)/e-m[0]/e,width:(m[1]+g)/i-m[1]/i}}return this.initCropRegion(e,i)},t.prototype.initCropRegion=function(t,e){var i,n,r,o;return this.cropRegion?e>t?(i=e/t,n=1,r=(t/2-e/2)/t,o=0):(i=1,n=t/e,r=0,o=(e/2-t/2)/e):e>t?(i=1,n=t/e,r=0,o=(e/2-t/2)/e):(i=e/t,n=1,r=(t/2-e/2)/t,o=0),{yMin:r,xMin:o,yMax:r+i,xMax:o+n,height:i,width:n}},t}();function Bt(t){return void 0===t&&(t=Ct),T(this,void 0,void 0,(function(){var i,n,r;return O(this,(function(o){switch(o.label){case 0:return(i=function(t){var e=null==t?Ct:F({},t);if(t.modelType){if(zt.indexOf(e.modelType)<0)throw new Error("Invalid architecture "+e.modelType+". Should be one of "+zt)}else t.modelType="SinglePose.Lightning";return null==e.enableSmoothing&&(e.enableSmoothing=!0),e}(t)).modelUrl?[4,e(i.modelUrl)]:[3,2];case 1:return n=o.sent(),[3,4];case 2:return r=void 0,"SinglePose.Lightning"===i.modelType?r="https://tfhub.dev/google/tfjs-model/movenet/singlepose/lightning/3":"SinglePose.Thunder"===i.modelType&&(r="https://tfhub.dev/google/tfjs-model/movenet/singlepose/thunder/3"),[4,e(r,{fromTFHub:!0})];case 3:n=o.sent(),o.label=4;case 4:return[2,new At(n,i)]}}))}))}var Nt={architecture:"MobileNetV1",outputStride:16,multiplier:.75,inputResolution:{height:257,width:257}},Vt=["MobileNetV1","ResNet50"],Kt={MobileNetV1:[8,16],ResNet50:[16]},Lt=[8,16,32],qt={MobileNetV1:[.5,.75,1],ResNet50:[1]},jt=[1,2,4],Dt={maxPoses:1,flipHorizontal:!1},Xt={maxPoses:5,flipHorizontal:!1,scoreThreshold:.5,nmsRadius:20},Ht=[-123.15,-115.9,-103.06];function Yt(t){return Math.floor(t/2)}var Ut=function(){function t(t,e){this.priorityQueue=new Array(t),this.numberOfElements=-1,this.getElementValue=e}return t.prototype.enqueue=function(t){this.priorityQueue[++this.numberOfElements]=t,this.swim(this.numberOfElements)},t.prototype.dequeue=function(){var t=this.priorityQueue[0];return this.exchange(0,this.numberOfElements--),this.sink(0),this.priorityQueue[this.numberOfElements+1]=null,t},t.prototype.empty=function(){return-1===this.numberOfElements},t.prototype.size=function(){return this.numberOfElements+1},t.prototype.all=function(){return this.priorityQueue.slice(0,this.numberOfElements+1)},t.prototype.max=function(){return this.priorityQueue[0]},t.prototype.swim=function(t){for(;t>0&&this.less(Yt(t),t);)this.exchange(t,Yt(t)),t=Yt(t)},t.prototype.sink=function(t){for(;2*t<=this.numberOfElements;){var e=2*t;if(e<this.numberOfElements&&this.less(e,e+1)&&e++,!this.less(t,e))break;this.exchange(t,e),t=e}},t.prototype.getValueAt=function(t){return this.getElementValue(this.priorityQueue[t])},t.prototype.less=function(t,e){return this.getValueAt(t)<this.getValueAt(e)},t.prototype.exchange=function(t,e){var i=this.priorityQueue[t];this.priorityQueue[t]=this.priorityQueue[e],this.priorityQueue[e]=i},t}();function Wt(t,e,i,n,r,o){for(var s=o.shape,a=s[0],l=s[1],h=!0,u=Math.max(i-r,0),c=Math.min(i+r+1,a),p=u;p<c;++p){for(var f=Math.max(n-r,0),d=Math.min(n+r+1,l),m=f;m<d;++m)if(o.get(p,m,t)>e){h=!1;break}if(!h)break}return h}function Qt(t){return T(this,void 0,void 0,(function(){return O(this,(function(e){return[2,Promise.all(t.map((function(t){return t.buffer()})))]}))}))}function Gt(t,e,i,n){return{y:n.get(t,e,i),x:n.get(t,e,i+17)}}function Zt(t,e,i){var n=Gt(t.heatmapY,t.heatmapX,t.id,i),r=n.y,o=n.x;return{x:t.heatmapX*e+o,y:t.heatmapY*e+r}}function $t(t,e,i,n){var r=i.x,o=i.y;return t.some((function(t){var i,s,a,l,h,u,c=t.keypoints;return i=o,s=r,a=c[n].y,l=c[n].x,(h=a-i)*h+(u=l-s)*u<=e}))}var Jt=P.reduce((function(t,e,i){return t[e]=i,t}),{}),te=[["nose","left_eye"],["left_eye","left_ear"],["nose","right_eye"],["right_eye","right_ear"],["nose","left_shoulder"],["left_shoulder","left_elbow"],["left_elbow","left_wrist"],["left_shoulder","left_hip"],["left_hip","left_knee"],["left_knee","left_ankle"],["nose","right_shoulder"],["right_shoulder","right_elbow"],["right_elbow","right_wrist"],["right_shoulder","right_hip"],["right_hip","right_knee"],["right_knee","right_ankle"]].map((function(t){var e=t[0],i=t[1];return[Jt[e],Jt[i]]})),ee=te.map((function(t){return t[1]})),ie=te.map((function(t){return t[0]}));function ne(t,e,i){return t<e?e:t>i?i:t}function re(t,e,i,n){return{y:ne(Math.round(t.y/e),0,i-1),x:ne(Math.round(t.x/e),0,n-1)}}function oe(t,e){return{x:t.x+e.x,y:t.y+e.y}}function se(t,e,i,n,r,o,s,a){void 0===a&&(a=2);for(var l=n.shape,h=l[0],u=l[1],c={y:e.y,x:e.x},p=oe(c,function(t,e,i){var n=i.shape[2]/2;return{y:i.get(e.y,e.x,t),x:i.get(e.y,e.x,n+t)}}(t,re(c,o,h,u),s)),f=0;f<a;f++){var d=re(p,o,h,u),m=Gt(d.y,d.x,i,r);p=oe({x:d.x*o,y:d.y*o},{x:m.x,y:m.y})}var g=re(p,o,h,u),y=n.get(g.y,g.x,i);return{y:p.y,x:p.x,name:P[i],score:y}}function ae(t,e,i,n,r,o){var s=e.shape[2],a=ee.length,l=new Array(s),h=t.part,u=t.score,c=Zt(h,n,i);l[h.id]={score:u,name:P[h.id],y:c.y,x:c.x};for(var p=a-1;p>=0;--p){var f=ee[p],d=ie[p];l[f]&&!l[d]&&(l[d]=se(p,l[f],d,e,i,n,o))}for(p=0;p<a;++p){f=ie[p],d=ee[p];l[f]&&!l[d]&&(l[d]=se(p,l[f],d,e,i,n,r))}return l}function le(t,e,i){return i.reduce((function(i,n,r){var o=n.y,s=n.x,a=n.score;return $t(t,e,{y:o,x:s},r)||(i+=a),i}),0)/i.length}function he(t,e,i,n,r,o,s,a){return void 0===s&&(s=.5),void 0===a&&(a=20),T(this,void 0,void 0,(function(){var l,h,u,c,p,f,d,m,g,y,v,x;return O(this,(function(w){switch(w.label){case 0:return[4,Qt([t,e,i,n])];case 1:for(l=w.sent(),h=l[0],u=l[1],c=l[2],p=l[3],f=[],d=function(t,e,i){for(var n=i.shape,r=n[0],o=n[1],s=n[2],a=new Ut(r*o*s,(function(t){return t.score})),l=0;l<r;++l)for(var h=0;h<o;++h)for(var u=0;u<s;++u){var c=i.get(l,h,u);c<t||Wt(u,c,l,h,e,i)&&a.enqueue({score:c,part:{heatmapY:l,heatmapX:h,id:u}})}return a}(s,1,h),m=a*a;f.length<o&&!d.empty();)g=d.dequeue(),y=Zt(g.part,r,u),$t(f,m,y,g.part.id)||(v=ae(g,h,u,r,c,p),x=le(f,m,v),f.push({keypoints:v,score:x}));return[2,f]}}))}))}function ue(t){var e=t.shape,i=e[0],n=e[1],r=e[2];return o((function(){var e,s,a=b(t,[i*n,r]),h=R(a,0),u=l(y(h,k(n,"int32")),1),p=l((e=h,s=n,o((function(){var t=y(e,k(s,"int32"));return x(e,c(t,k(s,"int32")))}))),1);return w([u,p],1)}))}function ce(t,e,i){return o((function(){var n=function(t,e){for(var i=[],n=0;n<P.length;n++){var r=t.get(n,0).valueOf(),o=t.get(n,1).valueOf(),a=pe(r,o,n,e),l=a.x,h=a.y;i.push(h),i.push(l)}return s(i,[P.length,2])}(t,i);return u(h(c(t.toTensor(),k(e,"int32")),"float32"),n)}))}function pe(t,e,i,n){return{y:n.get(t,e,i),x:n.get(t,e,i+P.length)}}function fe(t,e,i){return T(this,void 0,void 0,(function(){var n,r,o,s,a,l,h,u,c,p;return O(this,(function(f){switch(f.label){case 0:return n=0,r=ue(t),[4,Promise.all([t.buffer(),e.buffer(),r.buffer()])];case 1:return o=f.sent(),s=o[0],a=o[1],l=o[2],[4,(h=ce(l,i,a)).buffer()];case 2:return u=f.sent(),c=Array.from(function(t,e){for(var i=e.shape[0],n=new Float32Array(i),r=0;r<i;r++){var o=e.get(r,0),s=e.get(r,1);n[r]=t.get(o,s,r)}return n}(s,l)),p=c.map((function(t,e){return n+=t,{y:u.get(e,0),x:u.get(e,1),score:t,name:P[e]}})),r.dispose(),h.dispose(),[2,{keypoints:p,score:n/p.length}]}}))}))}function de(t,e){return(t-1)%e==0}var me="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/mobilenet/",ge="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/resnet50/";function ye(t,e){return function(t,e){return(t-1)%e==0}(t,e)?t:Math.floor(t/e)*e+1}var ve=function(){function t(t,e){this.posenetModel=t;var i=this.posenetModel.inputs[0].shape;r.assert(-1===i[1]&&-1===i[2],(function(){return"Input shape ["+i[1]+", "+i[2]+"] must both be equal to or -1"}));var n,o,s=(n=e.inputResolution,o=e.outputStride,{height:ye(n.height,o),width:ye(n.width,o)});!function(t){r.assert(Lt.indexOf(t)>=0,(function(){return"outputStride of "+t+" is invalid. It must be either 8 or 16."}))}(e.outputStride),function(t,e){r.assert(de(t.height,e),(function(){return"height of "+t.height+" is invalid for output stride "+e+"."})),r.assert(de(t.width,e),(function(){return"width of "+t.width+" is invalid for output stride "+e+"."}))}(s,e.outputStride),this.inputResolution=s,this.outputStride=e.outputStride,this.architecture=e.architecture}return t.prototype.estimatePoses=function(t,e){return void 0===e&&(e=Dt),T(this,void 0,void 0,(function(){var i,n,r,o,s,a,l,h,c,p,g,y,v,x,w;return O(this,(function(b){switch(b.label){case 0:return i=function(t){var e=t;if(null==e.maxPoses&&(e.maxPoses=1),e.maxPoses<=0)throw new Error("Invalid maxPoses "+e.maxPoses+". Should be > 0.");if(e.maxPoses>1){if((e=F({},Xt,e)).scoreThreshold<0||e.scoreThreshold>1)throw new Error("Invalid scoreThreshold "+e.scoreThreshold+". Should be in range [0.0, 1.0]");if(e.nmsRadius<=0)throw new Error("Invalid nmsRadius "+e.nmsRadius+".")}return e}(e),null==t?[2,[]]:(this.maxPoses=i.maxPoses,n=D(t,{inputResolution:this.inputResolution,keepAspectRatio:!0}),r=n.imageTensor,o=n.padding,s="ResNet50"===this.architecture?u(r,Ht):J(r,[-1,1]),a=this.posenetModel.predict(s),"ResNet50"===this.architecture?(l=d(a[2],[0]),h=d(a[3],[0]),c=d(a[0],[0]),p=d(a[1],[0])):(l=d(a[0],[0]),h=d(a[1],[0]),c=d(a[2],[0]),p=d(a[3],[0])),g=f(h),1!==this.maxPoses?[3,2]:[4,fe(g,l,this.outputStride)]);case 1:return v=b.sent(),y=[v],[3,4];case 2:return[4,he(g,l,c,p,this.outputStride,this.maxPoses,i.scoreThreshold,i.nmsRadius)];case 3:y=b.sent(),b.label=4;case 4:return x=K(t),w=function(t,e,i,n){var r=e.height,o=e.width,s=r/(i.height*(1-n.top-n.bottom)),a=o/(i.width*(1-n.left-n.right)),l=-n.top*i.height,h=-n.left*i.width;if(1===a&&1===s&&0===l&&0===h)return t;for(var u=0,c=t;u<c.length;u++)for(var p=0,f=c[u].keypoints;p<f.length;p++){var d=f[p];d.x=(d.x+h)*a,d.y=(d.y+l)*s}return t}(y,x,this.inputResolution,o),i.flipHorizontal&&(w=function(t,e){for(var i=0,n=t;i<n.length;i++)for(var r=0,o=n[i].keypoints;r<o.length;r++){var s=o[r];s.x=e.width-1-s.x}return t}(w,x)),r.dispose(),s.dispose(),m(a),l.dispose(),h.dispose(),c.dispose(),p.dispose(),g.dispose(),[2,w]}}))}))},t.prototype.dispose=function(){this.posenetModel.dispose()},t.prototype.reset=function(){},t}();function xe(t){return void 0===t&&(t=Nt),T(this,void 0,void 0,(function(){var i,n,r,o,s;return O(this,(function(a){switch(a.label){case 0:return"ResNet50"!==(i=function(t){var e=t||Nt;if(null==e.architecture&&(e.architecture="MobileNetV1"),Vt.indexOf(e.architecture)<0)throw new Error("Invalid architecture "+e.architecture+". Should be one of "+Vt);if(null==e.inputResolution&&(e.inputResolution={height:257,width:257}),null==e.outputStride&&(e.outputStride=16),Kt[e.architecture].indexOf(e.outputStride)<0)throw new Error("Invalid outputStride "+e.outputStride+". Should be one of "+Kt[e.architecture]+" for architecture "+e.architecture+".");if(null==e.multiplier&&(e.multiplier=1),qt[e.architecture].indexOf(e.multiplier)<0)throw new Error("Invalid multiplier "+e.multiplier+". Should be one of "+qt[e.architecture]+" for architecture "+e.architecture+".");if(null==e.quantBytes&&(e.quantBytes=4),jt.indexOf(e.quantBytes)<0)throw new Error("Invalid quantBytes "+e.quantBytes+". Should be one of "+jt+" for architecture "+e.architecture+".");if("MobileNetV1"===e.architecture&&32===e.outputStride&&1!==e.multiplier)throw new Error("When using an output stride of 32, you must select 1 as the multiplier.");return e}(t)).architecture?[3,2]:(l=i.outputStride,h=i.quantBytes,u="model-stride"+l+".json",n=4===h?ge+"float/"+u:ge+"quant"+h+"/"+u,[4,e(i.modelUrl||n)]);case 1:return r=a.sent(),[2,new ve(r,i)];case 2:return o=function(t,e,i){var n={1:"100",.75:"075",.5:"050"},r="model-stride"+t+".json";return 4===i?me+"float/"+n[e]+"/"+r:me+"quant"+i+"/"+n[e]+"/"+r}(i.outputStride,i.multiplier,i.quantBytes),[4,e(i.modelUrl||o)];case 3:return s=a.sent(),[2,new ve(s,i)]}var l,h,u}))}))}function we(t,e){return T(this,void 0,void 0,(function(){var i,n;return O(this,(function(r){switch(t){case Rt.PoseNet:return[2,xe(e)];case Rt.BlazePose:if(n=void 0,null!=(i=e)){if("tfjs"===i.runtime)return[2,Tt(e)];if("mediapipe"===i.runtime)return[2,V(e)];n=i.runtime}throw new Error("Expect modelConfig.runtime to be either 'tfjs' or 'mediapipe', but got "+n);case Rt.MoveNet:return[2,Bt(e)];default:throw new Error(t+" is not a supported model name.")}}))}))}var be={keypointsToNormalizedKeypoints:W},Me={modelType:{SINGLEPOSE_LIGHTNING:"SinglePose.Lightning",SINGLEPOSE_THUNDER:"SinglePose.Thunder"}};export{Rt as SupportedModels,be as calculators,we as createDetector,Me as movenet,Pt as util};
